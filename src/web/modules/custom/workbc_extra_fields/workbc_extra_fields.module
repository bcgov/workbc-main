<?php

use GuzzleHttp\Client;
use GuzzleHttp\Exception\RequestException;

define ("WORKBC_EXTRA_FIELDS_NOT_AVAILABLE", "n/a");

define ("REGION_CARIBOO", "Cariboo");
define ("REGION_KOOTENAY", "Kootenay");
define ("REGION_MAINLAND_SOUTHWEST", "Mainland/Southwest");
define ("REGION_NORTH_COAST_NECHAKO", "North Coast & Nechako");
define ("REGION_NORTHEAST", "Northeast");
define ("REGION_THOMPSON_OKANAGAN", "Thompson-Okanagan");
define ("REGION_VANCOUVER_ISLAND_COAST", "Vancouver Island-Coast");

/*

we use hook_entity_view instead of hook_entity_load as we along need to load data from SSoT
for the node that is being displayed, not for nodes that are being referenced.


*/
function workbc_extra_fields_node_view(array &$build, \Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display, $view_mode) {

  $data = array();
  if ($view_mode == "full") {
     switch($entity->bundle()) {
       case "career_profile":
        $entity->ssot_data = ssotCareerProfile($entity->get("field_noc")->getString());
        break;
       case "industry_profile":
       case "region_profile":
     }
  }
}

function ssotCareerProfile($noc) {

  $data = array();
  $data['wages'] = querySSoT('wages?noc=eq.' . $noc)[0];
  $data['career_provincial'] = querySSoT('career_provincial?noc=eq.' . $noc)[0];
  $data['career_regional'] = querySSoT('career_regional?noc=eq.' . $noc)[0];
  $data['census'] = querySSoT('census?noc=eq.' . $noc)[0];
  $data['education'] = querySSoT('education?noc=eq.' . $noc)[0];
  $data['skills'] = querySSoT('skills?noc=eq.' . $noc);
  $data['openings'] = querySSoT('openings?noc=eq.' . $noc)[0];
  // ksm($data);
  return $data;
}

function querySSoT($url) {
  $ssot = rtrim(\Drupal::config('workbc')->get('ssot_url'), '/');
  $client = new Client();
  try {
    $response = $client->get($ssot . '/' . $url);
    $result = json_decode($response->getBody(), TRUE);
    if (isset($result[0])) {
      $data = $result;
      return $data;
    }
  }
  catch (RequestException $e) {
    // log exception
  }
}
